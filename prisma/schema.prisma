// prisma/base.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// AUTO-GENERATED FROM prisma/models/*.prisma
// DO NOT EDIT THIS FILE DIRECTLY

// --- department.prisma ---

// prisma/models/department.prisma

model Department {
  id        String   @id @default(uuid())
  code      String   @unique // "OPD", "CASUALTY", "LAB", etc.
  name      String
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userAssignments UserAssignment[]
}


// --- designation.prisma ---

// prisma/models/designation.prisma

model Designation {
  id          String   @id @default(uuid())
  name        String   @unique        // "Consultant", "Resident", "Duty Doctor", etc.
  category    String                 // "clinical" | "nursing" | "support" | "admin"
  description String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  permissionGroups DesignationPermissionGroup[]
  workflowFlags    DesignationWorkflowFlag[]
  userAssignments  UserAssignment[]
}

/// Metadata for each workflow flag
model WorkflowFlag {
  id          String           @id @default(uuid())
  code        String           @unique            // e.g. "canBreakGlass"
  description String
  flagType    WorkflowFlagType @default(BOOLEAN)
  enumValues  String[]?

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  designationMappings DesignationWorkflowFlag[]
  userOverrides       UserWorkflowFlagOverride[]
}

/// Default mapping of Designation -> PermissionGroup (Basic behavior)
model DesignationPermissionGroup {
  id               String            @id @default(uuid())
  designation      Designation       @relation(fields: [designationId], references: [id])
  designationId    String

  group            PermissionGroup   @relation(fields: [permissionGroupId], references: [id])
  permissionGroupId Int

  mode             PermissionGroupMode

  @@unique([designationId, permissionGroupId])
}

/// Default mapping of Designation -> WorkflowFlag (logic layer)
model DesignationWorkflowFlag {
  id            String        @id @default(uuid())
  designation   Designation   @relation(fields: [designationId], references: [id])
  designationId String

  flag          WorkflowFlag  @relation(fields: [flagId], references: [id])
  flagId        String

  valueBool     Boolean?
  valueText     String?
  valueNumber   Float?

  @@unique([designationId, flagId])
}


// --- logs.prisma ---

// prisma/models/logs.prisma

model SessionLog {
  id         String    @id @default(uuid())
  sessionId  String
  userId     String
  createdAt  DateTime
  revokedAt  DateTime?
  expiredAt  DateTime?
  ipAddress  String?
  userAgent  String?
  browser    String?
  os         String?
  deviceType String?

  @@index([sessionId])
  @@index([userId])
  @@index([expiredAt])
  @@index([revokedAt])
}

model AuthLog {
  id              String   @id @default(uuid())
  userId          String
  sessionId       String?
  actingSessionId String?
  action          String
  ipAddress       String?
  userAgent       String?
  browser         String?
  os              String?
  deviceType      String?
  timestamp       DateTime @default(now())
  details         Json?

  @@index([userId])
  @@index([sessionId])
  @@index([actingSessionId])
  @@index([action])
}


// --- permissionGroups.prisma ---

// prisma/models/permissionGroups.prisma

enum PermissionGroupCode {
  PATIENT_ACCESS   // Group 1
  DOCUMENTATION    // Group 2
  ORDERS           // Group 3
  MEDICATION       // Group 4
  APPROVALS        // Group 5
}

enum PermissionGroupMode {
  NONE
  PARTIAL
  FULL
  DRAFT_ONLY
  OWN_NOTES
  EXECUTE_ONLY
  EMERGENCY_ONLY
  LIMITED
}

enum WorkflowFlagType {
  BOOLEAN
  ENUM
  NUMBER
}

/// Fixed permission groups with description
model PermissionGroup {
  id          Int                 @id @default(autoincrement())
  code        PermissionGroupCode @unique
  description String

  designationMappings DesignationPermissionGroup[]
}


// --- permissionOverrides.prisma ---

// prisma/models/permissionOverrides.prisma

model UserPermissionGroupOverride {
  id           String               @id @default(uuid())
  user         User                 @relation(fields: [userId], references: [id])
  userId       String

  department   Department?          @relation(fields: [departmentId], references: [id])
  departmentId String?

  groupCode    PermissionGroupCode
  modeOverride PermissionGroupMode?

  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  @@unique([userId, departmentId, groupCode])
}

/// Per-user override for WorkflowFlag
model UserWorkflowFlagOverride {
  id         String        @id @default(uuid())
  user       User          @relation(fields: [userId], references: [id])
  userId     String

  flag       WorkflowFlag  @relation(fields: [flagId], references: [id])
  flagId     String

  valueBool   Boolean?
  valueText   String?
  valueNumber Float?

  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  @@unique([userId, flagId])
}


// --- session.prisma ---

// prisma/models/session.prisma

model Session {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  expiresAt DateTime

  ipAddress      String?
  userAgent      String?
  browser        String?
  os             String?
  deviceType     String?
  lastActivityAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}


// --- user.prisma ---

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  phone     String?  @unique

  /// High-level app role (e.g. "SUPER_ADMIN", "HOSPITAL_ADMIN")
  /// Detailed clinical permissions are handled through assignments & capabilities.
  role      String   @default("ADMIN")

  status    String   @default("active") // "active" | "suspended" | "deleted"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sessions    Session[]
  password    UserPassword?
  assignments UserAssignment[]
  permissionGroupOverrides UserPermissionGroupOverride[]
  workflowFlagOverrides   UserWorkflowFlagOverride[]
  capabilities            UserCapabilities?
}


// --- userAssignments.prisma ---

// prisma/models/userAssignments.prisma

model UserAssignment {
  id            String      @id @default(uuid())
  user          User        @relation(fields: [userId], references: [id])
  userId        String

  department    Department  @relation(fields: [departmentId], references: [id])
  departmentId  String

  designation   Designation @relation(fields: [designationId], references: [id])
  designationId String

  isPrimary     Boolean     @default(false)

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([userId, departmentId, designationId])
}


// --- userCapabilities.prisma ---

// prisma/models/userCapabilities.prisma

model UserCapabilities {
  userId String @id
  user   User   @relation(fields: [userId], references: [id])

  // High-level type flags
  isDoctor       Boolean @default(false)
  isNurse        Boolean @default(false)
  isReceptionist Boolean @default(false)

  // Booking / assignment related
  isOPDBookable      Boolean @default(false)
  isCasualtyBookable Boolean @default(false)

  // Operational capabilities
  canRegisterPatient    Boolean @default(false)
  canPlaceLabOrder      Boolean @default(false)
  canApproveLabResult   Boolean @default(false)
  canDispensePharmacy   Boolean @default(false)
  canDoTriage           Boolean @default(false)

  // Critical safety flags
  canBreakGlass         Boolean @default(false)
  canEmergencyPrescribe Boolean @default(false)

  updatedAt DateTime @updatedAt
}


// --- userPassword.prisma ---

// prisma/models/userPassword.prisma

model UserPassword {
  id            String   @id @default(uuid())
  user          User     @relation(fields: [userId], references: [id])
  userId        String   @unique

  /// Bcrypt/Argon2 hash
  passwordHash  String

  passwordChangedAt DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

